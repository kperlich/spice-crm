/* * *******************************************************************************
* This file is part of KReporter. KReporter is an enhancement developed
* by aac services k.s.. All rights are (c) 2016 by aac services k.s.
*
* This Version of the KReporter is licensed software and may only be used in
* alignment with the License Agreement received with this Software.
* This Software is copyrighted and may not be further distributed without
* witten consent of aac services k.s.
*
* You can contact us at info@kreporter.org
******************************************************************************* */
Ext.define("SpiceCRM.KReporter.Dashlet.model.KReporterRecord",{extend:"Ext.data.Model",fields:["id","name","report_module","listfields","listtypeproperties","presentation_params","integration_params","visualization_params","reportoptions","union_modules","unionlistfields"]}),Ext.define("SpiceCRM.KReporter.Dashlet.controller.KReportViewerPresentationContainer",{extend:"Ext.app.ViewController",alias:"controller.KReportDashlet.KReportDashletPresentationContainer",loadMask:null,whereConfig:{},presPlugins:[],pluginsLoaded:{},pluginsaddLoaded:[],loaded:!1,presentationPanel:void 0,config:{listen:{global:{resize:function(){this.view.updateLayout()}}}},init:function(){this.initializeContainer()},initializeContainer:function(){this.view.removeAll(),this.view.record&&Ext.Ajax.request({url:"KREST/KReporter/plugins/action/kpublishing/getreportpresentationdata?record="+this.view.record,method:"GET",success:function(a,b){var c=Ext.decode(a.responseText);this.presPlugins=c.plugindata.presentation;var d={},e=Ext.util.Format.htmlDecode(c.report.presentation_params);e&&""!==e&&(d=Ext.decode(e)),Ext.ClassManager.get(this.presPlugins[d.plugin])?(this.presentationPanel=Ext.create(this.presPlugins[d.plugin].metadata.viewpanel,{reportRecord:Ext.create("SpiceCRM.KReporter.Dashlet.model.KReporterRecord",{id:this.view.record}),presentationParams:d,width:"100%",border:!1,target:"dashlet"}),this.view.add(this.presentationPanel)):Ext.Loader.loadScript({url:this.presPlugins[d.plugin].plugindirectory+"/"+this.presPlugins[d.plugin].metadata.includes.view,onLoad:function(){this.presentationPanel=Ext.create(this.presPlugins[d.plugin].metadata.viewpanel,{reportRecord:Ext.create("SpiceCRM.KReporter.Dashlet.model.KReporterRecord",c.report),presentationParams:d,width:"100%",border:!1,maxHeight:455,context:"Dashlet"}),this.view.add(this.presentationPanel)},onError:function(){console.log("error loading script")},scope:this})},failure:function(a,b){console.log("server-side failure with status code "+a.status)},scope:this})},updatePresentation:function(){this.presentationPanel.getController().reloadStore()}}),Ext.define("SpiceCRM.KReporter.Dashlet.view.PresentationContainer",{extend:"Ext.panel.Panel",controller:"KReportDashlet.KReportDashletPresentationContainer",width:"100%",minHeight:150,hidden:!1,border:!1,margin:"0 0 10 0",record:null,items:[{xtype:"panel",html:"hello",height:100}]}),Ext.define("SpiceCRM.KReporter.Dashlet.controller.KReportViewerVisualizationContainer",{extend:"Ext.app.ViewController",alias:"controller.KReportDashlet.KReportDashletVisualizationContainer",loadMask:null,whereConfig:{},viszualiationData:[],vizPlugins:[],pluginsLoaded:{},pluginsaddLoaded:[],loaded:!1,border:!1,vizParams:void 0,config:{listen:{global:{resize:function(){this.view.updateLayout()}}}},init:function(){this.initializeContainer()},initializeContainer:function(){this.view.removeAll(),this.view.record&&Ext.Ajax.request({url:"KREST/KReporter/plugins/action/kpublishing/getreportvisualizationdata?record="+this.view.record,method:"GET",success:function(a,b){var c=Ext.decode(a.responseText);this.vizPlugins=c.plugindata.visualization;var d={},e=Ext.util.Format.htmlDecode(c.visualization_params);e&&""!==e&&(d=Ext.decode(e)),d.layout&&"-"!==d.layout&&(this.vizParams=d,this.view.show(),d.chartheight?this.view.setHeight(d.chartheight):this.view.setHeight(300),this.loadMask||(this.loadMask=new Ext.LoadMask({msg:" .. loading Plugins ..",target:this.view})),this.loadMask.show());for(var f=1;void 0!==d[f];){var g=d[f];if(g.plugin&&void 0===this.pluginsLoaded[g.plugin]){this.pluginsLoaded[g.plugin]=!1;var h=this.vizPlugins[g.plugin];Ext.Loader.loadScript({url:h.plugindirectory+"/"+h.metadata.includes.view,onLoad:function(){this.pluginsLoaded[g.plugin]=!0,this.loadVisualization()},scope:this})}else this.loadVisualization();f++}},failure:function(a,b){console.log("server-side failure with status code "+a.status)},scope:this})},loadVisualization:function(){var a=!0;Ext.each(this.pluginsLoaded,function(b){b||(a=!1)},this),a&&!this.loaded&&(this.loaded=!0,this.loadMask.hide(),this.loadMask=new Ext.LoadMask({msg:" .. loading Visualizatiuon ..",target:this.view}),this.loadMask.show(),Ext.Ajax.request({url:"KREST/KReporter/"+this.view.record+"/visualization",params:{whereConditions:Ext.encode(this.operators),snapshotid:this.snapshotid},method:"GET",success:function(a){this.viszualiationData=Ext.JSON.decode(a.responseText),this.renderVisualization(),this.loadMask.hide()},failure:function(){this.loadMask.hide()},timeout:12e4,scope:this}))},renderVisualization:function(){this.view.removeAll(),Ext.each(this.viszualiationData,function(a){var b=this.vizPlugins[a.plugin];this.view.add(Ext.create(b.metadata.viewpanel,{id:a.uid+"_container",uid:a.uid,width:a.layout.width,height:this.calcVizHeight(a.layout.height),chartData:a.data,style:{position:"absolute",left:a.layout.left,top:a.layout.top}}))},this)},updateVisualization:function(){this.loadMask||(this.loadMask=new Ext.LoadMask({msg:" .. updating Visualization ..",target:this.view})),this.loadMask.show(),Ext.Ajax.request({url:"KREST/KReporter/"+this.view.record+"/visualization",method:"GET",success:function(a){this.viszualiationData=Ext.JSON.decode(a.responseText),Ext.each(this.viszualiationData,function(a){var b=this.view.down("#"+a.uid+"_container");b.updateChart(a)},this),this.loadMask.hide()},failure:function(){},timeout:12e4,scope:this})},calcVizHeight:function(a){return this.view.getHeight()/100*parseInt(a.replace("%",""))}}),Ext.define("SpiceCRM.KReporter.Dashlet.view.VisualizationContainer",{extend:"Ext.panel.Panel",controller:"KReportDashlet.KReportDashletVisualizationContainer",width:"100%",height:150,hidden:!1,border:!1,margin:"0 0 10 0",record:null,items:[{xtype:"panel",html:"hello",height:100}]});